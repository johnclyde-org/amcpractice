<!DOCTYPE html>
<html>
<head>
    <title>Online Test</title>
    <style>
        body { font-family: Arial, sans-serif; }
        #timer { position: fixed; top: 10px; right: 10px; font-size: 20px; color: blue; }
        .question {
            display: inline-block;
            border: 1px solid #999999;
            width: 26px;
            height: 31px;
            color: #666666;
            text-align: center;
            margin: 5px;
            line-height: 31px;
            cursor: pointer;
            background-color: #fff;
            font-size: 16px;
        }
        .question.selected {
            background-color: #b0c4de;
            color: #000000;
        }
        .question:hover {
            background-color: #f0f0f0;
        }
        #testSelectModal {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 1px solid #ddd;
            box-shadow: 0px 0px 10px rgba(0,0,0,0.5);
            z-index: 1000;
        }
        #reviewSection { margin: 10px; }
        /* Additional styles as needed */
    </style>
</head>
<body>
    <div id="timer"></div>
    <button id="toggleTimer">Unpause</button>
    <button id="importSaveState">Import Save State</button>
    <button id="exportSaveState">Export Save State</button>
    <button id="switchTest">Switch Test</button>

    <div id="testSelectModal" style="display:none;">
        <select id="testSelect"></select>
        <button id="confirmTestSelection">Select</button>
        <button id="cancelTestSelection">Cancel</button>
    </div>

    <div id="reviewSection">
        <strong>Review</strong>
        <div id="questions">
            <!-- Questions will be added here by JavaScript -->
        </div>
    </div>
    <div id="questionImage">
        <!-- Image for the selected problem -->
    </div>
    <script>
        var timerRunning = false;
        var seconds = 0;
        var interval;

        function updateTimer() {
            var currentTime = new Date();
            document.getElementById("timer").innerText = "Current Time: " + currentTime.toLocaleTimeString() +
                ", Elapsed Time: " + seconds + " seconds";
            if (timerRunning) seconds++;
        }

        function toggleTimer() {
            if (!timerRunning) {
                interval = setInterval(updateTimer, 1000);
                timerRunning = true;
                document.getElementById("toggleTimer").innerText = "Pause";
            } else {
                timerRunning = false;
                document.getElementById("toggleTimer").innerText = "Unpause";
            }
        }

        document.getElementById("toggleTimer").addEventListener("click", toggleTimer);

        function recordAction(testLabel, questionLabel, action, value) {
            var testsData = JSON.parse(localStorage.getItem("userActions")) || {};
            if (!testsData[testLabel]) {
                testsData[testLabel] = {};
            }
            if (!testsData[testLabel][questionLabel]) {
                testsData[testLabel][questionLabel] = [];
            }
            var entry = { timestamp: new Date().toISOString(), action: action, value: value };
            testsData[testLabel][questionLabel].push(entry);
            localStorage.setItem("userActions", JSON.stringify(testsData));
        }

        function createActionButtons(questionLabel) {
            var buttonsContainer = document.createElement('div');
            var guessButton = document.createElement('button');
            guessButton.innerText = 'Guess';
            var solveButton = document.createElement('button');
            solveButton.innerText = 'Solve';
            var tldrButton = document.createElement('button');
            tldrButton.innerText = 'TLDR';

            guessButton.onclick = function() {
                var guess = prompt("Your guess for " + questionLabel + ":");
                if (guess !== null) {
                    recordAction(currentTestData.set_label, questionLabel, "guess", guess);
                }
            };

            solveButton.onclick = function() {
                var solution = prompt("Your solution for " + questionLabel + ":");
                if (solution !== null) {
                    recordAction(currentTestData.set_label, questionLabel, "solve", solution);
                }
            };

            tldrButton.onclick = function() {
                recordAction(currentTestData.set_label, questionLabel, "tldr", "Marked as TLDR");
                // Implement navigation to the next problem here
            };

            buttonsContainer.appendChild(guessButton);
            buttonsContainer.appendChild(solveButton);
            buttonsContainer.appendChild(tldrButton);
            return buttonsContainer;
        }

        function navigateToQuestion(questionLabel) {
            // Highlight the selected question.
            var questionSpans = document.querySelectorAll('.question')
            questionSpans.forEach(function(span) {
                if (span.innerText === questionLabel) {
                    span.classList.add('selected');
                } else {
                    span.classList.remove('selected');
                }
            });

            // Highlight the selected question.
            var questionImage = document.getElementById('questionImage');
            questionImage.innerHTML = '';  // Clear previous image.

            // Add action buttons above the image.
            questionImage.appendChild(createActionButtons(questionLabel));
            var selectedProblem = currentTestData.problems.find(function(p) {
                return p.label === questionLabel;
            });
            console.log("Navigating to question " + questionLabel);
            if (selectedProblem && selectedProblem.link) {
                 var imgElement = document.createElement('img');
                 imgElement.src = selectedProblem.link;
                 imgElement.alt = selectedProblem.alternate_text || "Specify alternate_text in the problem JSON next time...";
                 questionImage.appendChild(imgElement);
            }

            // Add action buttons below the image.
            questionImage.appendChild(createActionButtons(questionLabel));
        }

        document.getElementById("importSaveState").addEventListener("click", function() {
            var input = prompt("Input your save state here:");
            if (input === null) {
                // User cancelled the prompt, do nothing.
            } else if (input) {
                try {
                    var jsonData;
                    try {
                        jsonData = JSON.parse(input); // Direct JSON input
                    } catch (e) {
                        var jsonInput = atob(input); // Base64 input
                        jsonData = JSON.parse(jsonInput);
                    }

                    var existingTests = localStorage.getItem("testData");
                    var tests = existingTests ? JSON.parse(existingTests) : [];

                    var replaceData = false;
                    var promptReplace = false;

                    if (Array.isArray(jsonData)) {
                        // Check if any entry in the array has 'set_label'
                        replaceData = jsonData.some(entry => entry.hasOwnProperty('set_label'));
                        promptReplace = replaceData; // Prompt for replacement if any entry has 'set_label'
                    } else if (jsonData.hasOwnProperty('set_label')) {
                        // Single object with 'set_label' should append
                        promptReplace = false; // No prompt needed for appending single entry
                        tests.push(jsonData); // Append the single entry
                    }

                    // If replacement is needed, prompt the user for confirmation
                    if (promptReplace) {
                        var confirmReplace = confirm("If you hit confirm your existing data will be GONE - otherwise the new data will be appended to what is there.");
                        if (confirmReplace) {
                            tests = jsonData; // Replace with new data
                        } else {
                            tests = tests.concat(jsonData);
                        }
                    }

                    // Update localStorage with the final 'tests' array
                    localStorage.setItem("testData", JSON.stringify(tests));
                    alert("Test imported successfully.");
                } catch (error) {
                    alert("Error parsing input: " + error);
                }
            } else {
                alert("No input provided.");
            }
        });

        document.getElementById("exportSaveState").addEventListener("click", function() {
            var existingTests = localStorage.getItem("testData");
            if (!existingTests) {
                alert("No save state to export.");
            } else {
                try {
                    var base64Data = btoa(existingTests);
                    prompt("Copy your save state: ", base64Data);
                } catch (error) {
                    alert("Error encoding data: " + error);
                }
            }
        });

        function populateTestDropdown() {
            var tests = JSON.parse(localStorage.getItem("testData") || "[]");
            var testSelect = document.getElementById("testSelect");
            testSelect.innerHTML = ""; // Clear existing options
            tests.forEach(function(test, index) {
                var option = document.createElement("option");
                option.value = index;
                option.textContent = test.set_label || `Test ${index + 1}`;
                testSelect.appendChild(option);
            });
        }

        document.getElementById("switchTest").addEventListener("click", function() {
            populateTestDropdown();
            document.getElementById("testSelectModal").style.display = "block";
        });

        document.getElementById("cancelTestSelection").addEventListener("click", function() {
            document.getElementById("testSelectModal").style.display = "none";
        });

        var currentTestData = null;

        function generateQuestions() {
            if (!currentTestData || !currentTestData.problems) {
                return;
            }
            var questionsContainer = document.getElementById("questions");
            questionsContainer.innerHTML = '';
            currentTestData.problems.forEach(function(problem) {
                var questionSpan = document.createElement("span");
                questionSpan.className = "question";
                questionSpan.innerText = problem.label;
                questionSpan.onclick = function() { navigateToQuestion(this.innerText); };
                questionsContainer.appendChild(questionSpan);
            });
        }

        document.getElementById("confirmTestSelection").addEventListener("click", function() {
            var selectedTestIndex = document.getElementById("testSelect").value;
            var tests = JSON.parse(localStorage.getItem("testData") || "[]");
            if (tests[selectedTestIndex]) {
                currentTestData = tests[selectedTestIndex];
                console.log("Current test set to:", currentTestData.set_label);
                generateQuestions();
                document.getElementById("testSelectModal").style.display = "none";
                navigateToQuestion(currentTestData.problems[0].label);
            }
        });

        generateQuestions();
        updateTimer(); // Initialize the timer display
    </script>
</body>
</html>
